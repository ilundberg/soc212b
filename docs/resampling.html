<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical Uncertainty: Bootstrap and Beyond – SOCIOL 212B: Quantitative Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">SOCIOL 212B: Quantitative Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./problem_sets.html"> 
<span class="menu-text">Problem Sets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./assets/syllabus.pdf"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./who_we_are.html"> 
<span class="menu-text">Who We Are</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./yhat_regression.html">Descriptive Data Science with Probability Samples</a></li><li class="breadcrumb-item"><a href="./resampling.html">Statistical uncertainty by resampling</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./asking_a_research_question.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Asking a Research Question</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Descriptive Data Science with Probability Samples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./yhat_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression for Y-hat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./algorithms_for_prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Algorithms for prediction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_driven_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data-driven selection of an estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resampling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Statistical uncertainty by resampling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Non-Probability Samples and Observational Causal Inference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonparametric_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nonparametric identification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prediction_for_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimation by prediction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./weighting_for_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimation by weighting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./doubly_robust.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Doubly-robust estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./panel_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Panel data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Additional topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Missing data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mediation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scale construction</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-motivating-problem" id="toc-a-motivating-problem" class="nav-link active" data-scroll-target="#a-motivating-problem">A motivating problem</a></li>
  <li><a href="#classical-inference" id="toc-classical-inference" class="nav-link" data-scroll-target="#classical-inference">Classical inference</a>
  <ul class="collapse">
  <li><a href="#plug-in-estimators" id="toc-plug-in-estimators" class="nav-link" data-scroll-target="#plug-in-estimators">Plug-in estimators</a></li>
  <li><a href="#classical-confidence-intervals" id="toc-classical-confidence-intervals" class="nav-link" data-scroll-target="#classical-confidence-intervals">Classical confidence intervals</a></li>
  </ul></li>
  <li><a href="#analytic-vs-computational-inference-procedures" id="toc-analytic-vs-computational-inference-procedures" class="nav-link" data-scroll-target="#analytic-vs-computational-inference-procedures">Analytic vs computational inference procedures</a></li>
  <li><a href="#the-estimator-function-s" id="toc-the-estimator-function-s" class="nav-link" data-scroll-target="#the-estimator-function-s">The estimator function <span class="math inline">\(s()\)</span></a></li>
  <li><a href="#the-nonparametric-bootstrap" id="toc-the-nonparametric-bootstrap" class="nav-link" data-scroll-target="#the-nonparametric-bootstrap">The nonparametric bootstrap</a></li>
  <li><a href="#nonparametric-bootstrap-standard-errors" id="toc-nonparametric-bootstrap-standard-errors" class="nav-link" data-scroll-target="#nonparametric-bootstrap-standard-errors">Nonparametric bootstrap standard errors</a></li>
  <li><a href="#bootstrap-confidence-intervals" id="toc-bootstrap-confidence-intervals" class="nav-link" data-scroll-target="#bootstrap-confidence-intervals">Bootstrap confidence intervals</a>
  <ul class="collapse">
  <li><a href="#normal-approximation" id="toc-normal-approximation" class="nav-link" data-scroll-target="#normal-approximation">Normal approximation</a></li>
  <li><a href="#percentile-method" id="toc-percentile-method" class="nav-link" data-scroll-target="#percentile-method">Percentile method</a></li>
  </ul></li>
  <li><a href="#bootstrap-for-machine-learning-algorithms" id="toc-bootstrap-for-machine-learning-algorithms" class="nav-link" data-scroll-target="#bootstrap-for-machine-learning-algorithms">Bootstrap for machine learning algorithms</a></li>
  <li><a href="#discussion-what-belongs-in-s" id="toc-discussion-what-belongs-in-s" class="nav-link" data-scroll-target="#discussion-what-belongs-in-s">Discussion: What belongs in <span class="math inline">\(s()\)</span>?</a></li>
  <li><a href="#beyond-simple-random-samples" id="toc-beyond-simple-random-samples" class="nav-link" data-scroll-target="#beyond-simple-random-samples">Beyond simple random samples</a>
  <ul class="collapse">
  <li><a href="#stratified-bootstrap" id="toc-stratified-bootstrap" class="nav-link" data-scroll-target="#stratified-bootstrap">Stratified bootstrap</a></li>
  <li><a href="#cluster-bootstrap" id="toc-cluster-bootstrap" class="nav-link" data-scroll-target="#cluster-bootstrap">Cluster bootstrap</a></li>
  <li><a href="#complex-survey-samples" id="toc-complex-survey-samples" class="nav-link" data-scroll-target="#complex-survey-samples">Complex survey samples</a></li>
  <li><a href="#computational-strategy-for-replicate-weights" id="toc-computational-strategy-for-replicate-weights" class="nav-link" data-scroll-target="#computational-strategy-for-replicate-weights">Computational strategy for replicate weights</a></li>
  <li><a href="#application-in-the-cps" id="toc-application-in-the-cps" class="nav-link" data-scroll-target="#application-in-the-cps">Application in the CPS</a></li>
  </ul></li>
  <li><a href="#a-word-of-warning" id="toc-a-word-of-warning" class="nav-link" data-scroll-target="#a-word-of-warning">A word of warning</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./yhat_regression.html">Descriptive Data Science with Probability Samples</a></li><li class="breadcrumb-item"><a href="./resampling.html">Statistical uncertainty by resampling</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Statistical Uncertainty: Bootstrap and Beyond</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>Here are <a href="slides/lec6/resampling_slides.pdf">slides</a> and a <a href="assets/pdf_chapters/resampling.pdf">PDF of this page</a>. Notation and ideas on this page loosely draw on <a href="https://hastie.su.domains/CASI/">Efron &amp; Hastie (2016)</a> Ch 10–11.</p>
</blockquote>
<p>As researchers adopt algorithmic estimation methods for which analytical standard errors do not exist, methods to produce standard errors by resampling become all the more important. We will discuss the bootstrap for simple random samples and extensions to allow resampling-based standard error estimates in complex survey samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">90095</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="a-motivating-problem" class="level2">
<h2 class="anchored" data-anchor-id="a-motivating-problem">A motivating problem</h2>
<p>Out of the population of baseball salaries on Opening Day 2023, imagine that we have a sample of 10 Dodger players.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/baseball_population.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sample <span class="ot">&lt;-</span> population <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(team <span class="sc">==</span> <span class="st">"L.A. Dodgers"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(player, team, salary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculate the mean salary among the sampled Dodgers to be $3.8 million. How much should we trust this estimate?</p>
<p>For the sake of discussion, we provide the following information.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  `Salary Among Sampled Dodgers`    Value
  &lt;chr&gt;                             &lt;dbl&gt;
1 sample_mean                    3829119.
2 sample_standard_deviation      6357851.
3 sample_size                         10 </code></pre>
</div>
</div>
</section>
<section id="classical-inference" class="level2">
<h2 class="anchored" data-anchor-id="classical-inference">Classical inference</h2>
<p>To know how confident to be in our sample-based estimate, we need to reason about why our sample-based estimate might differ from the true (but unknown) population parameter. Let <span class="math inline">\(\hat\mu\)</span> denote our estimate for the sample mean of <span class="math inline">\(Y\)</span>.</p>
<p><span class="math display">\[\hat\mu = \frac{1}{n}\sum_{i}Y_i\]</span></p>
<p>Across repeated samples from the population, the estimate <span class="math inline">\(\hat\mu\)</span> equals the population mean on average but differs in any particular sample due to random sampling variance. The sample variance of the mean has a known formula.</p>
<p><span class="math display">\[
V(\hat\mu) = V\left(\frac{1}{n}\sum_i Y_i\right) = \frac{1}{n^2}\sum_i V(Y_i) = \frac{V(Y)}{n}
\]</span></p>
<p>The sample-to-sample variance of <span class="math inline">\(\hat\mu\)</span> will be greater to the degree that <span class="math inline">\(Y\)</span> varies substantially across individuals in the population (larger <span class="math inline">\(V(Y)\)</span>), and will be smaller to the degree that many individuals are included in the sample (larger <span class="math inline">\(n\)</span>).</p>
<p>You might be more familiar with this equation expressed as the standard deviation of the estimator, sometimes referred to as the standard error, which is the square root of the variance of the estimator,</p>
<p><span class="math display">\[
\text{SD}(\hat\mu) = \sqrt{\text{V}(\hat\mu)} = \frac{\text{SD}(Y)}{\sqrt{n}}
\]</span> where <span class="math inline">\(\text{SD}()\)</span> is the standard deviation of <span class="math inline">\(Y\)</span> across individuals in the population.</p>
<p>From the Central Limit Theorem, we know that even if <span class="math inline">\(Y\)</span> is not Normally distributed the sample mean of <span class="math inline">\(Y\)</span> converges to a Normal distribution as the sample size grows. Because we have formulas for these parameters, we can write down a formula for that sampling distribution.</p>
<p><span class="math display">\[
\hat\mu \rightarrow \text{Normal}\left(\text{Mean} = \text{E}(Y),\quad \text{SD} = \frac{\text{SD}(Y)}{\sqrt{n}}\right)
\]</span> The graph below visualizes the sampling variability of the sample mean. Across repeated samples, the sample mean <span class="math inline">\(\hat\mu\)</span> is normally distributed about its true population value. The middle 95% of sample estimates <span class="math inline">\(\hat\mu\)</span> fall within a region that can be derived with known formulas,</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>where <span class="math inline">\(\Phi^{-1}()\)</span> is the inverse CDF of the standard Normal distribution.</p>
<p>You might be concerned: can a Normal distribution be a good approximation when Dodger player salaries are highly right-skewed? After all this is the distribution of Dodger player salaries.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>But the <em>sample mean</em> among 10 sampled Dodgers is actually quite close to a normal sampling distribution. This is because of the Central Limit Theorem.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="plug-in-estimators" class="level3">
<h3 class="anchored" data-anchor-id="plug-in-estimators">Plug-in estimators</h3>
<p>We have a formula for the standard deviation of the sample mean, but it involves the term <span class="math inline">\(\text{SD}(Y)\)</span> which is the unknown population standard deviation of <span class="math inline">\(Y\)</span>. It is common to plug in the sample estimate of this value in order to arrive at a sample estimate of the standard deviation of the estimator.</p>
<p><span class="math display">\[
\widehat{\text{SD}}(\hat\mu) = \frac{\widehat{\text{SD}}(Y)}{\sqrt{n}} = \sqrt{\frac{\frac{1}{n-1}\sum_i (Y_i - \bar{Y})^2}{n}}
\]</span></p>
<p>The idea of a plug-in estimator may seem obvious, but soon we will see that the step at which plug-ins occur changes dramatically when we move to resampling methods for statistical inference.</p>
</section>
<section id="classical-confidence-intervals" class="level3">
<h3 class="anchored" data-anchor-id="classical-confidence-intervals">Classical confidence intervals</h3>
<p>A 95% confidence interval <span class="math inline">\((\hat\mu_\text{Lower},\hat\mu_\text{Upper})\)</span> is an interval that has the property that across repeated samples the probability that <span class="math inline">\(\hat\mu_\text{Lower} &lt; \mu &lt; \hat\mu_\text{Upper}\)</span> is 0.95. One way to think about this is that two properties should hold: the probability that the lower limit is too high and the probability that the upper limit is too low are each 0.025.</p>
<p><span class="math display">\[
\begin{aligned}
\text{P}(\hat\mu_\text{Lower} &gt; \mu) &amp;= .025 \\
\text{P}(\hat\mu_\text{Upper} &lt; \mu) &amp;= .025
\end{aligned}
\]</span></p>
<p>You may know from statistics that a 95% confidence interval for the sample mean can be derived as follows.</p>
<p><span class="math display">\[
\hat\mu \pm \Phi^{-1}(.975)\widehat{\text{SD}}(\hat\mu)
\]</span> where <span class="math inline">\(\Phi^{-1}(.975)\)</span> is the value 1.96 that you might look up in the back of a statistics textbook. We can show that these confidence limits have the desired properties. For example, taking the lower limit:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{P}\left(\hat\mu_\text{Lower} &gt; \mu\right)\\
&amp;=\text{P}\left(\hat\mu - \Phi^{-1}(.975)\widehat{\text{SD}}(\hat\mu) &gt; \mu\right)\\
&amp;= \text{P}\left(\hat\mu - \mu &gt; \Phi^{-1}(.975)\widehat{\text{SD}}(\hat\mu)\right)\\
&amp;= \text{P}\left(\frac{\hat\mu - \mu}{\widehat{\text{SD}}(\hat\mu)} &gt; \Phi^{-1}(.975)\right)\\
&amp;= .025
\end{aligned}
\]</span></p>
<p>where the last line holds because <span class="math inline">\(\frac{\hat\mu - \mu}{\text{SD}(\hat\mu)}\)</span> follows a standard Normal distribution. The proof for the upper limit is similar.</p>
<p>Across repeated samples, a 95% confidence interval constructed in this way should contain the true mean 95% of the time. We can visualize this behavior by taking repeated samples of 10 Dodger players from our data.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this particular simulation, we have slight undercoverage and the upper confidence limit is often the one that is incorrect. These problems may arise because our asymptotic normality of mean salaries is an imperfect approximation at a sample size of <span class="math inline">\(n = 10\)</span>.</p>
</section>
</section>
<section id="analytic-vs-computational-inference-procedures" class="level2">
<h2 class="anchored" data-anchor-id="analytic-vs-computational-inference-procedures">Analytic vs computational inference procedures</h2>
<p>Analytical confidence intervals (derived by math) are the default for many researchers. Yet the exercise above reveals some of their shortcomings. First, there is a lot of math! Second, despite the math we still relied on the plug-in principle: for unknown quantities such as <span class="math inline">\(\text{SD}(Y)\)</span> we plug in sample-based estimates <span class="math inline">\(\widehat{\text{SD}}(Y)\)</span> and act as though these were known. Third, our results may still yield imperfect coverage because underlying assumptions may be only approximately met. For example, our confidence intervals may have undercovered because the asymptotics of the Central Limit Theorem are unreliable at <span class="math inline">\(n = 10\)</span>.</p>
<p>Now suppose you had a complicated data science approach, such as a predicted value <span class="math inline">\(\hat{Y}_{\vec{x}}=\hat{\text{E}}(Y\mid \vec{X} = \vec{x})\)</span> from a LASSO regression. How would you place a confidence interval on that predicted value?</p>
<p>Computational inference procedures take a different approach. These procedures focus on a generic estimator <span class="math inline">\(s()\)</span> applied to data. Instead of deriving properties of the estimator by math, computational approaches seek to simulate what would happen when <span class="math inline">\(s()\)</span> is applied to samples from the population, often by using a plug-in principle at an earlier step.</p>
</section>
<section id="the-estimator-function-s" class="level2">
<h2 class="anchored" data-anchor-id="the-estimator-function-s">The estimator function <span class="math inline">\(s()\)</span></h2>
<p>At the core of a resampling-based inference procedure is a broad sense of how our estimate comes to be. First, the world has some cumulative distribution function <span class="math inline">\(F\)</span> over data that could be generated. A particular sample <span class="math inline">\(\texttt{data}\)</span> is drawn from the probability distribution of the world. The researcher then applies an <strong>estimator function</strong> <span class="math inline">\(s()\)</span> that takes in and returns an estimate <span class="math inline">\(s(\texttt{data})\)</span>.</p>
<p><span class="math display">\[F\rightarrow \texttt{data} \rightarrow s(\texttt{data})\]</span></p>
<p>In our baseball example, the estimator function is the sample mean of the <code>salary</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">estimate =</span> <span class="fu">mean</span>(salary)) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(estimate)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We would like to repeatedly simulate <span class="math inline">\(\texttt{data}\)</span> from the world and see the performance of the estimator. But this is only possible in illustrations like the baseball example where the population data are known. When <span class="math inline">\(F\)</span> is unknown and we only see one <span class="math inline">\(\texttt{data}\)</span>, we need a new procedure.</p>
</section>
<section id="the-nonparametric-bootstrap" class="level2">
<h2 class="anchored" data-anchor-id="the-nonparametric-bootstrap">The nonparametric bootstrap</h2>
<p>The nonparametric bootstrap simulates repeated-sample behavior by a plug-in principle.</p>
<ol type="1">
<li>Plug in the empirical distribution <span class="math inline">\(\hat{F}\)</span> of our sample data as an estimate of the true distribution <span class="math inline">\(F\)</span> for the unobserved full population of data</li>
<li>Generate a bootstrap sample <span class="math inline">\(\texttt{data}^*\)</span> by sampling from our empirical data with replacement.</li>
<li>Generate an estimate <span class="math inline">\(s(\texttt{data}^*)\)</span> using the bootstrap data.</li>
<li>Repeat steps (2) and (3) many times to generate a large number <span class="math inline">\(B\)</span> of bootstrap replicate estimates.</li>
</ol>
<p>Visually, this procedure is analogous to the above.</p>
<p><span class="math display">\[\hat{F}\rightarrow \texttt{data}^* \rightarrow s(\texttt{data}^*)\]</span></p>
</section>
<section id="nonparametric-bootstrap-standard-errors" class="level2">
<h2 class="anchored" data-anchor-id="nonparametric-bootstrap-standard-errors">Nonparametric bootstrap standard errors</h2>
<p>In classical statistics, the standard error of an estimator is typically a mathematical expression derived for that particular estimator and then estimated by the plug-in principle. For example, the standard error of the mean is <span class="math inline">\(\text{SD}(\hat\mu) = \text{SD}(Y) / \sqrt{n}\)</span>.</p>
<p>With the bootstrap, we avoid this altogether because we have <span class="math inline">\(B\)</span> bootstrap replicate estimates. We can estimate the standard deviation of the estimator over repeated samples by the empirical standard deviation across bootstrap replicates.</p>
<p><span class="math display">\[
\widehat{\text{SD}}(s) = \frac{1}{B-1}\sum_{r=1}^B \bigg(s(\texttt{data}^*_r) - s(\texttt{data}^*_\bullet)\bigg)^2
\]</span> where <span class="math inline">\(s(\texttt{data}^*_\bullet)\)</span> is the mean of the estimate across the bootstrap samples. Note that just like the analytic standard errors, these have also relied on a plug-in principle: we plugged in the empirical distribution <span class="math inline">\(\hat{F}\)</span> for the population distribution <span class="math inline">\(F\)</span> when generating bootstrap samples from our empirical data instead of actual samples from the population.</p>
<p>In our baseball example, here is our sample of 10 Dodger players.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   player           team           salary
   &lt;chr&gt;            &lt;chr&gt;           &lt;dbl&gt;
 1 Barnes, Austin   L.A. Dodgers  3500000
 2 Reyes, Alex*     L.A. Dodgers  1100000
 3 Betts, Mookie    L.A. Dodgers 21158692
 4 Vargas, Miguel   L.A. Dodgers   722500
 5 May, Dustin      L.A. Dodgers  1675000
 6 Bickford, Phil   L.A. Dodgers   740000
 7 Jackson, Andre   L.A. Dodgers   722500
 8 Thompson, Trayce L.A. Dodgers  1450000
 9 Pepiot, Ryan*    L.A. Dodgers   722500
10 Peralta, David   L.A. Dodgers  6500000</code></pre>
</div>
</div>
<p>The code below generates a bootstrap sample from these 10 players by sampling 10 players with replacement. You will see that some players in the original sample do not appear, and others appear more than once.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sample <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">1</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   player         team           salary
   &lt;chr&gt;          &lt;chr&gt;           &lt;dbl&gt;
 1 Betts, Mookie  L.A. Dodgers 21158692
 2 Peralta, David L.A. Dodgers  6500000
 3 Barnes, Austin L.A. Dodgers  3500000
 4 Pepiot, Ryan*  L.A. Dodgers   722500
 5 Jackson, Andre L.A. Dodgers   722500
 6 May, Dustin    L.A. Dodgers  1675000
 7 Reyes, Alex*   L.A. Dodgers  1100000
 8 May, Dustin    L.A. Dodgers  1675000
 9 Vargas, Miguel L.A. Dodgers   722500
10 Peralta, David L.A. Dodgers  6500000</code></pre>
</div>
</div>
<p>The code below carries out 500 bootstrap samples and estimates the sample mean in each one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>bootstrap_estimates <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">r =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="at">.combine =</span> <span class="st">"c"</span>) <span class="sc">%do%</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  sample <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw a bootstrap sample</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">1</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the estimator</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">estimator</span>()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The figure below shows how that the bootstrap distribution of the estimator compares to the actual sampling distribution of the estimator (known in this case since the population is known).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The bootstrap distribution is more heaped on 10 distinct salary values: the particular 10 Dodger player salaries included in our sample. When the variable being summarized takes continuous values, it will generally be more discretized in the bootstrap setting because there are only the sample size <span class="math inline">\(n\)</span> distinct values instead of the population size <span class="math inline">\(N\)</span> of distinct values. Otherwise, the two distributions are similar.</p>
<p>The bootstrap estimate of the standard error in this case is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bootstrap_estimates <span class="sc">|&gt;</span> <span class="fu">sd</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1965073</code></pre>
</div>
</div>
<p>which is 86% of the size of the theoretical standard error of 2.2969632^{6}. Like all sample-based analogs to theoretical standard errors, the bootstrap estimate of the standard error can itself be sensitive to sampling variability.</p>
</section>
<section id="bootstrap-confidence-intervals" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-confidence-intervals">Bootstrap confidence intervals</h2>
<p>The discussion above has focused on using the bootstrap to estimate standard errors. There are many methods to construct confidence intervals using bootstrap procedures. Two of the most common are the Normal approximation method and the percentile method.</p>
<section id="normal-approximation" class="level3">
<h3 class="anchored" data-anchor-id="normal-approximation">Normal approximation</h3>
<p>The beginning of this page reviewed classical statistics in which we routinely rely on the Central Limit Theorem which ensures that sample mean estimators are asymptotically Normal. Likewise with the bootstrap, if we believe that <span class="math inline">\(s(\texttt{data})\)</span> has a Normal sampling distribution, then we can construct a confidence interval by the Normal approximation with the bootstrap estimate of the standard error.</p>
<p><span class="math display">\[
s(\texttt{data}) \pm \Phi^{-1}(.975)\text{SD}\big(s(\text{data}^*)\big)
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">estimator</span>(sample) <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>) <span class="sc">*</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>) <span class="sc">*</span> <span class="fu">sd</span>(bootstrap_estimates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  -22353.11 7680591.51</code></pre>
</div>
</div>
</section>
<section id="percentile-method" class="level3">
<h3 class="anchored" data-anchor-id="percentile-method">Percentile method</h3>
<p>The bootstrap also offers another way to calculate the confidence interval: the middle 95% of the bootstrap estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(bootstrap_estimates, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   2.5%   97.5% 
1103406 8216408 </code></pre>
</div>
</div>
<!-- Should add more justification of percentile intervals. In what sense do they guarantee that the probability of the lower limit being above the truth is 2.5%? -->
<p>The percentile method can work better than the Normal approximation method in cases where normality does not hold. For example, in the beginning of this page we used analytic intervals that seemed imperfect in part because the Central Limit Theorem had not adequately yielded normality at a sample size of 10.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="bootstrap-for-machine-learning-algorithms" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-for-machine-learning-algorithms">Bootstrap for machine learning algorithms</h2>
<p>Suppose a researcher carries out the following procedure.</p>
<ol type="1">
<li>Sample <span class="math inline">\(n\)</span> units from the population</li>
<li>Learn an algorithm <span class="math inline">\(\hat{f}:\vec{X}\rightarrow Y\)</span> to minimize squared error</li>
<li>Report a prediction <span class="math inline">\(\hat{\text{E}}(Y\mid\vec{X} = \vec{x}) = \hat{f}(\vec{x})\)</span></li>
</ol>
<p>How would the researcher use the bootstrap to carry out this process?</p>
<ol type="1">
<li>Draw a bootstrap sample <span class="math inline">\(\texttt{data}^*\)</span> of size <span class="math inline">\(n\)</span></li>
<li>Learn the algorithm <span class="math inline">\(\hat{f}^*\)</span> in the bootstrap sample</li>
<li>Store the bootstrap estimate <span class="math inline">\(\hat{f}^*(\vec{x})\)</span></li>
</ol>
<p>Then the researcher could create a confidence interval with either the Normal approximation or the percentile method. Note that the bootstrap confidence interval may have undercoverage if the estimator is biased; see the words of warning at the end of this page.</p>
</section>
<section id="discussion-what-belongs-in-s" class="level2">
<h2 class="anchored" data-anchor-id="discussion-what-belongs-in-s">Discussion: What belongs in <span class="math inline">\(s()\)</span>?</h2>
<p>In each example, describe the steps the researcher might use to bootstrap this estimate while capturing all sources of uncertainty.</p>
<ol type="1">
<li>A researcher first truncates the values of a skewed predictor variable <span class="math inline">\(x\)</span> at the 1st and 99th percentile. Then the researcher learns a regression model and reports <span class="math inline">\(\hat\beta\)</span>.</li>
<li>A researcher first uses cross-validation to select the tuning parameter <span class="math inline">\(\lambda\)</span> for ridge regression. Then, they estimate ridge regression with the chosen <span class="math inline">\(\lambda\)</span> value and make a prediction <span class="math inline">\(\hat{f}(\vec{x})\)</span> at some predictor value <span class="math inline">\(\vec{x}\)</span> of interest.</li>
<li>A researcher first learns a prediction function <span class="math inline">\(\hat{f}:\vec{X}\rightarrow Y\)</span> and then sees which subgroup <span class="math inline">\(\vec{x}\)</span> has the highest predicted value <span class="math inline">\(\hat{f}(\vec{x})\)</span>, which the researcher reports.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answers
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Many steps of the analysis involve uncertainty. It can be ideal to include them all in your bootstrap! Write your estimator function to take in your raw data and return an estimate. The estimator function would include steps like truncating predictors at sample quantiles, choosing tuning parameters, and choosing subgroups of interest on which to focus.</p>
</div>
</div>
</div>
</section>
<section id="beyond-simple-random-samples" class="level2">
<h2 class="anchored" data-anchor-id="beyond-simple-random-samples">Beyond simple random samples</h2>
<p>The bootstrap in its simplest form is designed for simple random samples. Straightforward generalizations make it possible to move beyond simple random samples to more complex sampling designs.</p>
<section id="stratified-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="stratified-bootstrap">Stratified bootstrap</h3>
<p>Suppose we draw a sample of players stratified by team: 10 players per team. No matter which random sample is drawn, there will always be 10 Dodgers, 10 Angels, 10 Yankees, and so on. Stratified sampling is often a more efficient estimator than simple random sampling, and our estimator should reflect that!</p>
<p>As an example, suppose we have a stratified sample of 10 players per team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>stratified_sample <span class="ot">&lt;-</span> population <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(team) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We would generate a stratified bootstrap sample<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> by stratifying by team, exactly as the data were generated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>stratified_bootstrap_sample <span class="ot">&lt;-</span> stratified_sample <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(team) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">1</span>, <span class="at">replace =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Stratified bootstrapping can be important. Using our baseball example, suppose our estimator is the predicted mean salary of the Dodgers from a linear regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> team_past_salary, <span class="at">data =</span> data)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  to_predict <span class="ot">&lt;-</span> population <span class="sc">|&gt;</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(team <span class="sc">==</span> <span class="st">"L.A. Dodgers"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(team_past_salary)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(ols, <span class="at">newdata =</span> to_predict)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(predicted)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get different estimates if we carry out simple vs stratified bootstrap sampling.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cluster-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="cluster-bootstrap">Cluster bootstrap</h3>
<p>Suppose we draw a sample of players clustered by team: all players on 10 sampled teams. Clustered sampling is often less expensive than simple random sampling because it can be easier for the person carrying out the survey. This often comes at a cost of statistical efficiency.</p>
<p>As an example, suppose we have a clustered sample of 10 teams.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>clustered_sample <span class="ot">&lt;-</span> population <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(team) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(population, <span class="at">by =</span> <span class="fu">join_by</span>(team))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We would generate a clustered bootstrap sample by resampling teams instead of players, exactly as the data were sampled.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>chosen_teams <span class="ot">&lt;-</span> clustered_sample <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(team) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="dv">1</span>, <span class="at">replace =</span> T)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>clustered_bootstrap_sample <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(chosen_teams), <span class="at">.combine =</span> <span class="st">"rbind"</span>) <span class="sc">%do%</span> {</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  chosen_teams[i,] <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(clustered_sample, <span class="at">by =</span> <span class="fu">join_by</span>(team))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, we get different estimated standard errors if we carry out clustered bootstrap sampling vs standard bootstrap sampling.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="complex-survey-samples" class="level3">
<h3 class="anchored" data-anchor-id="complex-survey-samples">Complex survey samples</h3>
<p>Many surveys involve complex samples, such as samples stratified by state and then clustered in regions within states. Often the variables that define sampling strata or clusters are geographic, and therefore they are often redacted from the data made available to researchers due to privacy concerns.</p>
<p>Thankfully, many surveys make <strong>replicate weights</strong> available to researchers. The goal of replicate weights is to enable you to resample the data in a way that mimics the (hidden) ways in which the sample was originally drawn. The rest of this section walks through the use of replicate weights, first in a hypothetical example and then in real data.</p>
<p>When we download data, we typically download a column of weights. For simplicity, suppose we are given a sample of four people. The <code>weight</code> column tells us how many people in the population each person represents. The <code>employed</code> column tells us whether each person employed.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>     name weight employed
1    Luis      4        1
2 William      1        0
3   Susan      1        0
4  Ayesha      4        1</code></pre>
</div>
</div>
<p>If we take an unweighted mean, we would conclude that only 50% of the population is employed. But with a weighted mean, we would conclude that 80% of the population is employed! This might be the case if the sample was designed to oversample people at a high risk of unemployment.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Estimator</th>
<th style="text-align: left;">Math</th>
<th style="text-align: left;">Example</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Unweighted mean</td>
<td style="text-align: left;"><span class="math inline">\(=\frac{\sum_{i=1}^n Y_i}{n}\)</span></td>
<td style="text-align: left;"><span class="math inline">\(=\frac{1 + 0 + 0 + 1}{4}\)</span></td>
<td style="text-align: left;">= 50% employed</td>
</tr>
<tr class="even">
<td style="text-align: left;">Weighted mean</td>
<td style="text-align: left;"><span class="math inline">\(=\frac{\sum_{i=1}^n w_iY_i}{\sum_{i=1}^n w_i}\)</span></td>
<td style="text-align: left;"><span class="math inline">\(=\frac{4*1 + 1*0 + 1*0 + 4*1}{4 + 1 + 1 + 4}\)</span></td>
<td style="text-align: left;">= 80% employed</td>
</tr>
</tbody>
</table>
<p>In R, the <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/weighted.mean.html"><code>weighted.mean(x, w)</code></a> function will calculate weighted means where <code>x</code> is an argument for the outcome variable and <code>w</code> is an argument for the weight variable.</p>
<p>When you face a complex survey sample, those who administer the survey might provide</p>
<ul>
<li>a vector of <span class="math inline">\(n\)</span> weights for making a point estimate</li>
<li>a matrix of <span class="math inline">\(n\times k\)</span> replicate weights for making standard errors</li>
</ul>
<p>By providing <span class="math inline">\(k\)</span> different ways to up- and down-weight various observations, the replicate weights enable you to generate <span class="math inline">\(k\)</span> estimates that vary in a way that mimics how the estimator might vary if applied to different samples from the population. For instance, our employment sample might come with 3 replicate weights.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>     name weight employed repwt1 repwt2 repwt3
1    Luis      4        1      3      5      3
2 William      1        0      1      2      2
3   Susan      1        0      3      1      1
4  Ayesha      4        1      5      3      4</code></pre>
</div>
</div>
<p>The procedure to use replicate weights depends on how they are constructed. Often, it is relatively straightforward:</p>
<ul>
<li>use <code>weight</code> to create a point estimate <span class="math inline">\(\hat\tau\)</span></li>
<li>use <code>repwt*</code> to generate <span class="math inline">\(k\)</span> replicate estimates <span class="math inline">\(\hat\tau^*_1,\dots,\hat\tau^*_k\)</span></li>
<li>calculate the standard error of <span class="math inline">\(\hat\tau\)</span> using the replicate estimates <span class="math inline">\(\hat\tau^*\)</span>. The formula will depend on how the replicate weights were constructed, but it will likely involve the standard deviation of the <span class="math inline">\(\hat\tau^*\)</span> multiplied by some factor</li>
<li>construct a confidence interval<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> by a normal approximation <span class="math display">\[(\text{point estimate}) \pm 1.96 * (\text{standard error estimate})\]</span></li>
</ul>
<p>In our concrete example, the point estimate is 80% employed. The replicate estimates are 0.67, 0.73, 0.70. Variation across the replicate estimates tells us something about how the estimate would vary across hypothetical repeated samples from the population.</p>
</section>
<section id="computational-strategy-for-replicate-weights" class="level3">
<h3 class="anchored" data-anchor-id="computational-strategy-for-replicate-weights">Computational strategy for replicate weights</h3>
<p>Using replicate weights can be computationally tricky! It becomes much easier if you write an <code>estimator()</code> function. Your function accepts two arguments</p>
<ul>
<li><code>data</code> is the <code>tibble</code> containing the data</li>
<li><code>weight_name</code> is the name of a column containing the weight to be used (e.g., “repwt1”)</li>
</ul>
<p><strong>Example.</strong> If our estimator is the weighted mean of employment,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data, weight_name) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">estimate =</span> <span class="fu">weighted.mean</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> employed,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract the weight column</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">w =</span> sim_rep <span class="sc">|&gt;</span> <span class="fu">pull</span>(weight_name)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract the scalar estimate</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(estimate)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code above, <code>sim_rep |&gt; pull(weight_name)</code> takes the data frame <code>sim_rep</code> and extracts the weight variable that is named <code>weight_name</code>. There are other ways to do this also.</p>
<p>We can now apply our estimator to get a point estimate with the main sampling weight,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">estimator</span>(<span class="at">data =</span> sim_rep, <span class="at">weight_name =</span> <span class="st">"weight"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which yields the point estimate 0.80. We can use the same function to produce the replicate estimates,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>replicate_estimates <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimator</span>(<span class="at">data =</span> sim_rep, <span class="at">weight_name =</span> <span class="st">"repwt1"</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimator</span>(<span class="at">data =</span> sim_rep, <span class="at">weight_name =</span> <span class="st">"repwt2"</span>),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimator</span>(<span class="at">data =</span> sim_rep, <span class="at">weight_name =</span> <span class="st">"repwt3"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>yielding the three estimates: 0.67, 0.73, 0.70. In real data, you will want to apply this in a loop because there may be dozens of replicate weights.</p>
<p>The standard error of the estimator will be some function of the replicate estimates, likely involving the standard deviation of the replicate estimates. Check with the data distributor for a formula for your case. Once you estimate the standard error, a 95% confidence interval can be constructed with a Normal approximation, as discussed above.</p>
</section>
<section id="application-in-the-cps" class="level3">
<h3 class="anchored" data-anchor-id="application-in-the-cps">Application in the CPS</h3>
<p>Starting in 2005, the CPS-ASEC samples include 160 replicate weights. If you download replicate weights for many years, the file size will be enormous. We illustrate the use of replicate weights with a question that can be explored with only one year of data: among 25-year olds in 2023, how did the proportion holding four-year college degrees differ across those identifying as male and female?</p>
<p>We first load some packages, including the <code>foreach</code> package which will be helpful when looping through replicate weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To answer our research question, we download 2023 CPS-ASEC data including the variables <a href="https://cps.ipums.org/cps-action/variables/SEX"><code>sex</code></a>, <a href="https://cps.ipums.org/cps-action/variables/EDUC"><code>educ</code></a>, <a href="https://cps.ipums.org/cps-action/variables/AGE"><code>age</code></a>, the weight variable <a href="https://cps.ipums.org/cps-action/variables/ASECWT"><code>asecwt</code></a>, and the replicate weights <a href="https://cps.ipums.org/cps-action/variables/REPWTP"><code>repwtp*</code></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>cps_data <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"data_raw/cps_00079.dta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then define an estimator to use with these data. It accepts a tibble <code>data</code> and a character <code>weight_name</code> identifying the name of the weight variable, and it returns a tibble with two columns: <code>sex</code> and <code>estimate</code> for the estimated proportion with a four-year degree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>estimator <span class="ot">&lt;-</span> <span class="cf">function</span>(data, weight_name) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define focal_weight to hold the selected weight</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">focal_weight =</span> data <span class="sc">|&gt;</span> <span class="fu">pull</span>(weight_name)) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict to those age 25+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">25</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict to valid reports of education</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(educ <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> educ <span class="sc">&lt;</span> <span class="dv">999</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define a binary outcome: a four-year degree</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">college =</span> educ <span class="sc">&gt;=</span> <span class="dv">110</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate weighted means by sex</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(sex) <span class="sc">|&gt;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">estimate =</span> <span class="fu">weighted.mean</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> college,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">w =</span> focal_weight</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We produce a point estimate by applying that estimator with the <code>asecwt</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">estimator</span>(<span class="at">data =</span> cps_data, <span class="at">weight_name =</span> <span class="st">"asecwt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  sex        estimate
  &lt;dbl+lbl&gt;     &lt;dbl&gt;
1 1 [male]      0.369
2 2 [female]    0.397</code></pre>
</div>
</div>
<p>Using the <code>foreach</code> package, we apply the estimator 160 times—once with each replicate weight—and use the argument <code>.combine = "rbind"</code> to stitch results together by rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>replicate_estimates <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">r =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">160</span>, <span class="at">.combine =</span> <span class="st">"rbind"</span>) <span class="sc">%do%</span> {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">estimator</span>(<span class="at">data =</span> cps_data, <span class="at">weight_name =</span> <span class="fu">paste0</span>(<span class="st">"repwtp"</span>,r))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 320 × 2
   sex        estimate
   &lt;dbl+lbl&gt;     &lt;dbl&gt;
 1 1 [male]      0.368
 2 2 [female]    0.396
 3 1 [male]      0.371
 4 2 [female]    0.400
 5 1 [male]      0.371
 6 2 [female]    0.397
 7 1 [male]      0.369
 8 2 [female]    0.397
 9 1 [male]      0.370
10 2 [female]    0.398
# ℹ 310 more rows</code></pre>
</div>
</div>
<p>We estimate the standard error of our estimator by a formula <span class="math display">\[\text{StandardError}(\hat\tau) = \sqrt{\frac{4}{160}\sum_{r=1}^{160}\left(\hat\tau^*_r - \hat\tau\right)^2}\]</span> where the formula comes from the <a href="https://cps.ipums.org/cps/repwt.shtml#q40">survey documentation</a>. We carry out this procedure within groups defined by sex, since we are producing estimate for each sex.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>standard_error <span class="ot">&lt;-</span> replicate_estimates <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Denote replicate estimates as estimate_star</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">estimate_star =</span> estimate) <span class="sc">|&gt;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge in the point estimate</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(estimate,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(sex)) <span class="sc">|&gt;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Carry out within groups defined by sex</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sex) <span class="sc">|&gt;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply the formula from survey documentation</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">standard_error =</span> <span class="fu">sqrt</span>(<span class="dv">4</span> <span class="sc">/</span> <span class="dv">160</span> <span class="sc">*</span> <span class="fu">sum</span>((estimate_star <span class="sc">-</span> estimate) <span class="sc">^</span> <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  sex        standard_error
  &lt;dbl+lbl&gt;           &lt;dbl&gt;
1 1 [male]          0.00280
2 2 [female]        0.00291</code></pre>
</div>
</div>
<p>Finally, we combine everything and construct a 95% confidence interval by a Normal approximation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> estimate <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(standard_error, <span class="at">by =</span> <span class="st">"sex"</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ci_min =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> standard_error,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">ci_max =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> standard_error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  sex        estimate standard_error ci_min ci_max
  &lt;dbl+lbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 1 [male]      0.369        0.00280  0.364  0.375
2 2 [female]    0.397        0.00291  0.391  0.403</code></pre>
</div>
</div>
<p>We use <code>ggplot()</code> to visualize the result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>result <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sex =</span> <span class="fu">as_factor</span>(sex)) <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> sex, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin =</span> ci_min, </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax =</span> ci_max,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(estimate)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>() <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Sex"</span>, </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> str_to_title</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="st">"Proportion with 4-Year College Degree"</span>) <span class="sc">+</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sex Disparities in College Completion"</span>,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Estimates from the 2023 CPS-ASEC among those age 25+"</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="resampling_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We conclude that those identifying as female are more likely to hold a college degree. Because we can see the confidence intervals generated using the replicate weights, we are reasonably confident in the statistical precision of our point estimates.</p>
</section>
</section>
<section id="a-word-of-warning" class="level2">
<h2 class="anchored" data-anchor-id="a-word-of-warning">A word of warning</h2>
<p>The bootstrap is a powerful tool, but there are notable cases in which it fails.</p>
<p>First, all frequentist confidence intervals that are based solely on sampling variance may suffer undercoverage if applied to biased estimators. For example, many machine learning algorithms induce bias through regularization. This means that even if we correctly approximate sampling variance, the center of our confidence intervals may be systematically misaligned from the true population parameter, yielding undercoverage.</p>
<p>Second, the bootstrap can exhibit unexpected performance with statistics such as the maximum or minimum value, since these statistics can be sensitive to a particular data point. Taking the maximum as an example, the value <span class="math inline">\(\text{max}(\vec{y}^*)\)</span> in a bootstrap sample will never be higher than <span class="math inline">\(\text{max}(\vec{y})\)</span> in the sample from which that bootstrap was drawn. The entire bootstrap distribution of <span class="math inline">\(\text{max}(\vec{y}^*)\)</span> will be at or below the original estimate of <span class="math inline">\(\text{max}(\vec{y})\)</span>. Like the max or min, quantiles of <span class="math inline">\(\vec{y}\)</span> can also lead to unexpected bootstrap behavior. Generally the bootstrap will have the best performance for statistics such as the mean for which no particular unit plays an especially determining role.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Called the “multi-sample bootstrap” in Efron &amp; Hastie.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If we hypothetically drew many complex survey samples from the population in this way, an interval generated this way would contain the true population mean 95% of the time.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>