<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Doubly-robust estimation – SOCIOL 212B: Quantitative Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">SOCIOL 212B: Quantitative Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./problem_sets.html"> 
<span class="menu-text">Problem Sets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./assets/syllabus.pdf"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./who_we_are.html"> 
<span class="menu-text">Who We Are</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./nonparametric_identification.html">Non-Probability Samples and Observational Causal Inference</a></li><li class="breadcrumb-item"><a href="./doubly_robust.html">Doubly-robust estimation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./asking_a_research_question.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Asking a Research Question</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Descriptive Data Science with Probability Samples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./yhat_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression for Y-hat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./algorithms_for_prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Algorithms for prediction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_driven_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data-driven selection of an estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical uncertainty by resampling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Non-Probability Samples and Observational Causal Inference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonparametric_identification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nonparametric identification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prediction_for_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimation by prediction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./weighting_for_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimation by weighting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./doubly_robust.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Doubly-robust estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./panel_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Panel data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Additional topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Missing data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mediation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scale construction</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-motivating-example" id="toc-a-motivating-example" class="nav-link active" data-scroll-target="#a-motivating-example">A motivating example</a>
  <ul class="collapse">
  <li><a href="#we-are-always-the-child" id="toc-we-are-always-the-child" class="nav-link" data-scroll-target="#we-are-always-the-child">We are always the child</a></li>
  <li><a href="#correcting-the-childs-wrong-model" id="toc-correcting-the-childs-wrong-model" class="nav-link" data-scroll-target="#correcting-the-childs-wrong-model">Correcting the child’s wrong model</a></li>
  </ul></li>
  <li><a href="#augmented-inverse-probability-weighting" id="toc-augmented-inverse-probability-weighting" class="nav-link" data-scroll-target="#augmented-inverse-probability-weighting">Augmented inverse probability weighting</a>
  <ul class="collapse">
  <li><a href="#double-robustness" id="toc-double-robustness" class="nav-link" data-scroll-target="#double-robustness">Double robustness</a></li>
  </ul></li>
  <li><a href="#targeted-learning" id="toc-targeted-learning" class="nav-link" data-scroll-target="#targeted-learning">Targeted learning</a>
  <ul class="collapse">
  <li><a href="#modeling-y1-for-the-atc" id="toc-modeling-y1-for-the-atc" class="nav-link" data-scroll-target="#modeling-y1-for-the-atc">Modeling <span class="math inline">\(Y^1\)</span> for the ATC</a></li>
  <li><a href="#modeling-both-y0-and-y1" id="toc-modeling-both-y0-and-y1" class="nav-link" data-scroll-target="#modeling-both-y0-and-y1">Modeling both <span class="math inline">\(Y^0\)</span> and <span class="math inline">\(Y^1\)</span></a></li>
  <li><a href="#why-tmle-vs-aipw" id="toc-why-tmle-vs-aipw" class="nav-link" data-scroll-target="#why-tmle-vs-aipw">Why TMLE vs AIPW?</a></li>
  </ul></li>
  <li><a href="#sample-splitting-for-machine-learning" id="toc-sample-splitting-for-machine-learning" class="nav-link" data-scroll-target="#sample-splitting-for-machine-learning">Sample splitting for machine learning</a>
  <ul class="collapse">
  <li><a href="#cross-fitting" id="toc-cross-fitting" class="nav-link" data-scroll-target="#cross-fitting">Cross fitting</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./nonparametric_identification.html">Non-Probability Samples and Observational Causal Inference</a></li><li class="breadcrumb-item"><a href="./doubly_robust.html">Doubly-robust estimation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Doubly-robust estimation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- Class plan
- discuss open project questions
- walk through example again
- doubly robust in math
- see what terms are zero in each case
- doubly robust in code
- TMLE in visuals / math / code
- why would the line be flat if outcome model correct?
- flyover of course
- brainstorm topics for 212c
-->
<p>This session combines prediction and weighting methods for an approach with properties superior to either on its own. Here are <a href="slides/lec10/double_robust.pdf">slides</a>.</p>
<section id="a-motivating-example" class="level2">
<h2 class="anchored" data-anchor-id="a-motivating-example">A motivating example</h2>
<p>A child loves to go surfing. Every day, the child either surfs or the child does not. At the end of every day, the child records the height of the waves that day and whether they surfed. They also record the awesomeness of their day on a scale from 1–10, with 10 being the most awesome. The figure below visualizes some hypothetical data. When the child doesn’t surf (red dots), the day is always mediocre (awesomeness = 5). When the child surfs, the awesomeness of the day depends on the wave quality. When the waves are only 1 foot high, the day is less awesome than surfing because the child is constantly struggling to catch anything. As the wave height increases, the awesomeness increases up to a wave height of 3 feet, which is the peak of awesomeness for this child. Above 3 feet, awesomeness begins to decline up through 5 foot waves, in which the child struggles against the overwhelming power of these large waves.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>), <span class="at">a =</span> F) <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,<span class="dv">9</span><span class="sc">:</span><span class="dv">1</span>), <span class="at">a =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pi =</span> <span class="fu">mean</span>(a)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y1 =</span> <span class="dv">9</span> <span class="sc">-</span> <span class="dv">9</span> <span class="sc">*</span> ((x <span class="sc">-</span> <span class="dv">5</span>) <span class="sc">/</span> <span class="dv">5</span>) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y0 =</span> <span class="dv">5</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shift x to fit story of this DGP</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> (x <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span>a <span class="sc">~</span> y0,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      a <span class="sc">~</span> y1</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> a)) <span class="sc">+</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Height of Waves (feet)"</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Awesomeness of Child's Day</span><span class="sc">\n</span><span class="st">(Scale 1-10)"</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Did not surf"</span>,<span class="st">"Surfed"</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The parent also plays an improtant role here. When the waves are small, the parent almost always allows the child to surf. As the waves get larger, there are more days when the parent does not allow the chid to surf. When the waves are 5 feet tall, the child surfs only very rarely (when the parent misjudges the size of the waves). As a result, when the child thinks about days that they surf, the child’s experience of surfing tends to be in 1–3 foot waves.</p>
<p>The child secretly aspires to be a statistician, and thus asks a causal question: how much more awesome would the days I did not surf have been, if I had counterfactually surfed on those days? The child’s causal estimand is the average treatment effect on the untreated observations.</p>
<p><span class="math display">\[\tau = \frac{1}{n_\text{Not Surfed}}\sum_{i:A_i=\text{Not Surfed}} \left(Y_i^\text{Surfed} - Y_i^\text{Not Surfed}\right)\]</span></p>
<p>To answer this causal question, the child uses linear regression:</p>
<ol type="1">
<li>Model (awesomeness) given (wave height), among days when they surfed</li>
<li>Predict the counterfactual awesomeness under surfing, for the days when they did not surf</li>
</ol>
<p>Because most of the child’s surfing experiences are at the left side of the plot, the child fits a positive trend line: surfing days just get more awesome as the wave height increases. The child can easily forget about that bad 5-foot day; it was an anomaly that happened only once.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(a))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>fitted <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">predict</span>(fit1, <span class="at">newdata =</span> data))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> a)) <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Height of Waves (feet)"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Awesomeness of Child's Day</span><span class="sc">\n</span><span class="st">(Scale 1-10)"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Did not surf"</span>,<span class="st">"Surfed"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the fitted line</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fitted <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">a =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Knowledgable about outcome modeling for causal inference, the child proceeds to focus on the red dots: the days that they did not surf. For every red dot, the child predicts the counterfactual outcome: how awesome that day would have been if they had surfed. Especially on large-wave days, the model suggests the awesomeness would have been so much higher if the child had surfed!</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> a)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">show.legend =</span> F) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">data =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>a), <span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">data =</span> fitted <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>a) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">a =</span> T), <span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the fitted line</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fitted <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>a) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">a =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_segment(aes(yend = fitted), linetype = "dashed", color = "gray") +</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Height of Waves (feet)"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Awesomeness of Child's Day</span><span class="sc">\n</span><span class="st">(Scale 1-10)"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Did not surf</span><span class="sc">\n</span><span class="st">(factual data)"</span>,<span class="st">"Surfed</span><span class="sc">\n</span><span class="st">(counterfactual predictions)"</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> T)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">4.5</span>, <span class="at">y =</span> <span class="fl">6.5</span>, <span class="at">label =</span> <span class="st">"big</span><span class="sc">\n</span><span class="st">causal</span><span class="sc">\n</span><span class="st">effect</span><span class="sc">\n</span><span class="st">estimates"</span>) <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">"segment"</span>, <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">5</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">5.5</span>,<span class="fl">5.5</span>), <span class="at">yend =</span> <span class="fu">c</span>(<span class="fl">7.5</span>,<span class="fl">8.5</span>), <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(.<span class="dv">1</span>,<span class="st">"in"</span>)),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.height =</span> <span class="fu">unit</span>(.<span class="dv">5</span>,<span class="st">"in"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As a result, the child overestimates the value of <span class="math inline">\(\tau\)</span>: the average non-surfing day would have been 1.6 points more awesome on average if the child had surfed, but the child’s linear model mistakenly estimates that it would have been 2.94 points more awesome.</p>
<p>What went wrong with the child’s model? The child’s model minimized squared error over the distribution of wave heights where surfing days were observed. These tended to be small-wave days. But the prediction task was to predict on the non-surfing days, which tended to be big-wave days!</p>
<section id="we-are-always-the-child" class="level3">
<h3 class="anchored" data-anchor-id="we-are-always-the-child">We are always the child</h3>
<p>When carrying out model-based causal inference, we must realize we are always the child. We always have a treatment (surfing) that is unequally distributed across the values of one or more confounders (wave height). We fit an outcome model on the data we observe (surfing on small-wave days) and then use that model to predict counterfactuals we don’t observe (which tend to be big-wave days). Finally, just like the child we often assume a simple model (e.g., a line) without realizing that the world is more complicated (in this case, a parabola).</p>
<p>The solution to the child’s problem will be a solution that we can apply in many cases.</p>
</section>
<section id="correcting-the-childs-wrong-model" class="level3">
<h3 class="anchored" data-anchor-id="correcting-the-childs-wrong-model">Correcting the child’s wrong model</h3>
<p>The child actually has other information relevant to the problem: the child knows the proportion of days surfed at each wave height. In this case, the probability of surfing declines linearly from 90% on 1-foot days to 10% on 5-foot days.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> pi)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Propensity Score"</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Height of Waves (feet)"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Probability that Parent</span><span class="sc">\n</span><span class="st">Allows Child to Surf"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To be even more concrete, consider 5-foot wave days. The child knows that they surfed only 10% of these days. Every day surfed really stands in for 9 days not surfed. If we were estimating the average treatment effect on the untreated by weighting, we would weight the 5-foot day by <span class="math inline">\(\text{P}(\text{Not Surfed}\mid X = 5) / \text{P}(\text{Surfed} \mid X = 5) = .9 / .1 = 9\)</span>. We therefore might estimate the weighted error of the linear model, weighted by these weights.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>observed_error <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fitted =</span> <span class="fu">predict</span>(fit1, <span class="at">newdata =</span> data)) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(a) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> (<span class="dv">1</span> <span class="sc">-</span> pi) <span class="sc">/</span> pi)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>observed_error <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y1)) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted)) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">y =</span> y1, <span class="at">size =</span> weight), <span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">yend =</span> fitted), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Height of Waves (feet)"</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Awesomeness of Child's Day</span><span class="sc">\n</span><span class="st">(Scale 1-10)"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Inverse Probability</span><span class="sc">\n</span><span class="st">of Treatment Weight"</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Did not surf"</span>,<span class="st">"Surfed"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case, the unweighted average error is 0 which is unsurprising: in OLS the average error in the training data is always 0! But here the goal is to predict in a shifted distribution of wave height. The inverse-probability-weighted error estimates the error on average over the space where we are making predictions: the model predictions are on average 1.34 points too high.</p>
</section>
</section>
<section id="augmented-inverse-probability-weighting" class="level2">
<h2 class="anchored" data-anchor-id="augmented-inverse-probability-weighting">Augmented inverse probability weighting</h2>
<p>If the child corrected for the error, they would be using an augmented inverse probability weighting estimator.</p>
<p><span class="math display">\[
\hat\tau_\text{AIPW} = \frac{1}{n_\text{Not Surfed}}\sum_{i:A_i=\text{Not Surfed}} \left(\hat{Y}_i^1 - Y_i\right) - \frac{\sum_{i:A_i=\text{Surfed}} w_i\left(\hat{Y}^1_i - Y_i\right)}{\sum_{i:A_i=\text{Surfed}} w_i}
\]</span> where <span class="math inline">\(w_i\)</span> is the inverse probability weight for estimating the average treatment effect on the untreated.</p>
<p><span class="math display">\[
w_i = \frac{\text{P}(A=\text{Not Surfed}\mid X = x_i)}{\text{P}(A=\text{Surfed} \mid X = x_i)}
\]</span></p>
<p>In this example, the outcome model is misspecified (a line for a parabola) but the weights are correct. Below, we see that the weights allow us to correct the wrong outcome model.</p>
<p>First, we generate simulated data for this example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>), <span class="at">a =</span> F) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,<span class="dv">9</span><span class="sc">:</span><span class="dv">1</span>), <span class="at">a =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pi =</span> <span class="fu">mean</span>(a)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y1 =</span> <span class="dv">9</span> <span class="sc">-</span> <span class="dv">9</span> <span class="sc">*</span> ((x <span class="sc">-</span> <span class="dv">5</span>) <span class="sc">/</span> <span class="dv">5</span>) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y0 =</span> <span class="dv">5</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shift x to fit story of this DGP</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> (x <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span>a <span class="sc">~</span> y0,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      a <span class="sc">~</span> y1</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculate the truth because in the simulation we know the potential outcomes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>truth <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to the untreated</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>a) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average difference in potential outcomes</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">true_atc =</span> <span class="fu">mean</span>(y1 <span class="sc">-</span> y0)) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  true_atc
     &lt;dbl&gt;
1      1.6</code></pre>
</div>
</div>
<p>Then we calculate an initial estimate via outcome modeling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>initial_estimate <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict Y1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yhat1 =</span> <span class="fu">predict</span>(fit1, <span class="at">newdata =</span> data)) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Focus on the untreated</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>a) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarize an average effect estimate:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># average of (predicted y1) - (observed y0)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">initial_estimate =</span> <span class="fu">mean</span>(yhat1 <span class="sc">-</span> y)) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  initial_estimate
             &lt;dbl&gt;
1             2.94</code></pre>
</div>
</div>
<p>Third, we estimate the weighted mean error in the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>weighted_mean_error <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict Y1</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yhat1 =</span> <span class="fu">predict</span>(fit1, <span class="at">newdata =</span> data)) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Focus on the treated</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(a) <span class="sc">|&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct inverse probability weights</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># where pi is the probability of treatment</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> (<span class="dv">1</span> <span class="sc">-</span> pi) <span class="sc">/</span> pi) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarize a weighted mean error:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weighted average of (predicted y1) - (observed y1)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">weighted_mean_error =</span> <span class="fu">weighted.mean</span>(yhat1 <span class="sc">-</span> y, <span class="at">w =</span> weight)) <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  weighted_mean_error
                &lt;dbl&gt;
1                1.34</code></pre>
</div>
</div>
<p>Finally, our corrected estimate is the initial estimate with the weighted mean error subtracted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>corrected_estimate <span class="ot">&lt;-</span> initial_estimate <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(weighted_mean_error) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">corrected_estimate =</span> initial_estimate <span class="sc">-</span> weighted_mean_error) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  initial_estimate weighted_mean_error corrected_estimate
             &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;
1             2.94                1.34                1.6</code></pre>
</div>
</div>
<p>In this case, the corrected estimate equals the true average treatment effect among the untreated! This numerical equivalence occurs because this simulation has known propensity scores and zero random error.</p>
<section id="double-robustness" class="level3">
<h3 class="anchored" data-anchor-id="double-robustness">Double robustness</h3>
<p>The example above illustrates a key property of the AIPW estimator: it is doubly robust, meaning that it is a consistent estimator as long as either</p>
<ul>
<li>the model for treatment probabilities is consistent at each value of <span class="math inline">\(\vec{X}\)</span>, or</li>
<li>the model for potential outcomes is consistent at each value of <span class="math inline">\(\vec{X}\)</span></li>
</ul>
<p>Below, we consider each of these in turn.</p>
<p>The example above illustrated the first property: as long as the estimator of the treatment probabilities is consistent for the true probabilities of treatment, then the AIPW estimator is consistent for the truth. This is true even if the outcome model is wrong, as shown by the child’s line above!</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{if}\quad &amp;&amp;\hat{\text{P}}(A = 1 \mid\vec{X} = \vec{x})\rightarrow \text{P}(A = 1 \mid\vec{X} = \vec{x})\quad \text{ for all }\vec{x},\\
&amp;\text{then}\qquad &amp;&amp;\hat\tau_{\text{AIPW}}\rightarrow \tau
\end{aligned}
\]</span></p>
<p>Although not illustrated above, the AIPW estimator is also correct if the outcome model is correct and the treatment model is wrong. To illustrate this, consider that at every value of <span class="math inline">\(\vec{X}\)</span> an outcome model will be correct on average. Thus in a large sample, the average error at every value of <span class="math inline">\(\vec{X}\)</span> will be 0. No matter how we take a weighted average across the <span class="math inline">\(\vec{X}\)</span> values, the AIPW correction will always be 0! Thus the correct outcome model estimate will remain.</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{if}\quad &amp;&amp;\hat{\text{E}}(Y\mid A = 1, \vec{X} = \vec{x})\rightarrow \text{E}(Y\mid A = 1, \vec{X} = \vec{x})\quad \text{ for all }\vec{x},\\
&amp;\text{then}\qquad &amp;&amp;\hat\tau_{\text{AIPW}}\rightarrow \tau
\end{aligned}
\]</span></p>
</section>
</section>
<section id="targeted-learning" class="level2">
<h2 class="anchored" data-anchor-id="targeted-learning">Targeted learning</h2>
<p>AIPW is not the only way to update a model. Another option is called targeted learning (<a href="https://link.springer.com/book/10.1007/978-1-4419-9782-1">Van der Laan and Rose 2011</a>). We first introduce targeted learning through one concrete example, then generalize the procedure in the sections that follows.</p>
<section id="modeling-y1-for-the-atc" class="level3">
<h3 class="anchored" data-anchor-id="modeling-y1-for-the-atc">Modeling <span class="math inline">\(Y^1\)</span> for the ATC</h3>
<p>In the surfing example, our goal is to estimate the mean outcome under surfing, for the observations on days when there was surfing. We begin with the child’s initial fit: linear regression. Following notation that is common in targeted learning,<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> we will refer to this regression line as <span class="math inline">\(\hat{Q}^0\)</span>,</p>
<p><span class="math display">\[
\underbrace{\hat{Q}^0(\vec{x})}_{\substack{\text{The 0 superscript}\\\text{indicates an untargeted}\\\text{initial estimate}}} = \hat{\text{E}}(Y\mid A = 1, \vec{X}) = \hat\alpha + \hat\beta\vec{x}
\]</span></p>
<p>where <span class="math inline">\(\hat\alpha\)</span> and <span class="math inline">\(\hat\beta\)</span> are the OLS coefficients when modeling <span class="math inline">\(Y\)</span> given <span class="math inline">\(X\)</span> among the treated observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>q0_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(a))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to return predictions</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>q0 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(q0_fit, <span class="at">newdata =</span> <span class="fu">tibble</span>(x))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The child’s model is targeted toward the observed data, but our target is actually to predict the counterfactual under surfing for the observations when the child did not surf. These are disproportionately at the right side of the figure. If we were estimating by inverse probability weighting, we would weight each treated observation by the ratio of untreated to treated observations given <span class="math inline">\(X\)</span>. For targeted learning, we will call this a “clever covariate” that we will define as function <span class="math inline">\(H()\)</span>.</p>
<p><span class="math display">\[
H(x) = \frac{\text{P}(A = \text{Not Surfed} \mid X = x)}{\text{P}(A = \text{Surfed}\mid X = x)}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the propensity scores</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (assumed known in this example)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>propensity_scores <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(x,pi)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the clever covariate function</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(propensity_scores, <span class="at">by =</span> <span class="fu">join_by</span>(x)) <span class="sc">|&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">h =</span> (<span class="dv">1</span> <span class="sc">-</span> pi) <span class="sc">/</span> pi) <span class="sc">|&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(h)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The problem of non-targeted estimation is that our model errors are systematically related to the importance of each observation. To visualize this, create a graph with the clever covariate on the <span class="math inline">\(x\)</span>-axis and the initial estimate errors on the <span class="math inline">\(y\)</span>-axis.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The graph shows that the observed <span class="math inline">\(Y\)</span> values (awesomeness of the day) were especially far below the predicted <span class="math inline">\(Y\)</span>-values at the right side of the graph: big-wave days when the clever covariate is very large. The regression line is a best-fit line for the errors with intercept restricted to equal 0. Equivalently, it is a best-fit line for <span class="math inline">\(Y\)</span> with the initial prediction <span class="math inline">\(\hat{Q}^0(X)\)</span> included as an offset (an intercept with coefficient restricted to equal 1). The latter interpretation will be useful for generalizations.</p>
<p><span class="math display">\[
\hat{\text{E}}^1(Y\mid X = x) = \hat{Q}^1(x) = \hat{Q}^0(x) + \hat\gamma \underbrace{\left(\frac{\text{P}(A = \text{Not surfed}\mid X = x)}{\text{P}(A = \text{Surfed}\mid X = x)}\right)}_{\text{Clever covariate }h(x)}
\]</span></p>
<p>We can visualize the targeted outcome prediction function <span class="math inline">\(\hat{Q}^1\)</span>, which corrects for misspecification of the original model. It does not perfectly match the response surface, but its error equals zero on average over the space where predictions will be made. The targeted fit is nonlinear because the clever covariate is a nonlinear function of <span class="math inline">\(X\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> a)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> .<span class="dv">1</span>, <span class="at">height =</span> .<span class="dv">1</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Height of Waves (feet)"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Awesomeness of Child's Day</span><span class="sc">\n</span><span class="st">(Scale 1-10)"</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Did not surf"</span>,<span class="st">"Surfed"</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the untargeted line</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fitted <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">a =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"Initial Fit Q0"</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the fitted line</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fitted <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">q1</span>(x)),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"Targeted Fit Q1"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">linetype =</span> <span class="fu">expression</span>(Predicted<span class="sc">~</span>Y<span class="sc">^</span>{Surfed}<span class="sc">~</span>Values))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we return to our goal: estimating the counterfactual awesomeness of non-surfing days if the child had surfed on those days. We can now make two estimates, each of which compares the predicted outcomes under surfing (<span class="math inline">\(\hat{Q}^0(x)\)</span> and <span class="math inline">\(\hat{Q}^1(x)\)</span>) to the observed outcomes under no surfing.</p>
<p><span class="math display">\[
\begin{aligned}
\text{Initial estimate:}\qquad &amp;&amp;\hat\tau^0 &amp;= \frac{1}{n_{\text{NotSurfed}}}\sum_{i:A_i=\text{NotSurfed}}\left(\hat{Q}^0(x_i) - y_i\right)\\
\text{Targeted estimate:}\qquad &amp;&amp;\hat\tau^1 &amp;= \frac{1}{n_{\text{NotSurfed}}}\sum_{i:A_i=\text{NotSurfed}}\left(\hat{Q}^1(x_i) - y_i\right)
\end{aligned}
\]</span></p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 39%">
<col style="width: 17%">
<col style="width: 18%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">Initial Estimate</th>
<th style="text-align: right;">Targeted Estimate</th>
<th style="text-align: right;">Truth (Y1 Not Observed)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mean Predicted Outcome Under Surfing</td>
<td style="text-align: right;">7.9</td>
<td style="text-align: right;">6.6</td>
<td style="text-align: right;">6.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mean Observed Outcome Under No Surfing</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">5.0</td>
<td style="text-align: right;">5.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Effect of Surfing</td>
<td style="text-align: right;">2.9</td>
<td style="text-align: right;">1.6</td>
<td style="text-align: right;">1.6</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="modeling-both-y0-and-y1" class="level3">
<h3 class="anchored" data-anchor-id="modeling-both-y0-and-y1">Modeling both <span class="math inline">\(Y^0\)</span> and <span class="math inline">\(Y^1\)</span></h3>
<p>In the section above, we focused on untreated cases and took the observed <span class="math inline">\(Y\)</span> values as <span class="math inline">\(Y^0\)</span> estimates instead of predicting from a regression model. More generally, we might be interested in both the treated and untreated cases (e.g., for an average treatment effect) and would need model-based estimates for both <span class="math inline">\(Y^0\)</span> and <span class="math inline">\(Y^1\)</span>.</p>
<p>When modeling both potential outcomes, we begin with an initial estimate of the conditional mean function: linear regression estimated separately on the treated and untreated observations. As before, the 0 superscripts indicate that this is an initial estimate.</p>
<p><span class="math display">\[
\begin{aligned}
\hat{Q}^0(a,\vec{x}) &amp;= \hat{\text{E}}^0(Y\mid A = a, \vec{X} = \vec{x}) = \begin{cases}
\hat\alpha_0 + \vec{x}'\hat\beta_0 &amp;\text{if }a = 0 \\
\hat\alpha_1 + \vec{x}'\hat\beta_1 &amp;\text{if }a = 1
\end{cases}
\end{aligned}
\]</span> In code, we can estimate these two regression models</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>a))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and construct the <span class="math inline">\(\hat{Q}^0\)</span> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>q0 <span class="ot">&lt;-</span> <span class="cf">function</span>(a,x) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  to_predict <span class="ot">&lt;-</span> <span class="fu">tibble</span>(a,x)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  to_predict <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">q0 =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">predict</span>(fit1, <span class="at">newdata =</span> to_predict),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">predict</span>(fit0, <span class="at">newdata =</span> to_predict)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(q0)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Using the <span class="math inline">\(\hat{Q}^0\)</span> function, we can produce an initial estimate of the ATE.</p>
<p><span class="math display">\[
\hat\tau_\text{ATE}^0 = \underbrace{\frac{1}{n}\sum_i}_\text{Sample average} \bigg(\underbrace{\hat{Q}^0(1,x_i)}_{\substack{\text{Initial prediction}\\\text{under treatment}}} - \underbrace{\hat{Q}^0(0,x_i)}_{\substack{\text{Initial prediction}\\\text{under control}}}\bigg)
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial_ate_estimate =</span> <span class="fu">mean</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">q0</span>(<span class="dv">1</span>,x) <span class="sc">-</span> <span class="fu">q0</span>(<span class="dv">0</span>,x)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  initial_ate_estimate
                 &lt;dbl&gt;
1                 2.27</code></pre>
</div>
</div>
<p>We know that this estimate is wrong because of the misspecified outcome model optimized over the observed data instead of the data to be predicted. To correct this misspecification, we define the clever covariate.</p>
<ul>
<li>because the goal is the ATE, this is the inverse probability of treatment</li>
<li>because we difference (treatment) – (control), the control weight is negative</li>
</ul>
<p><span class="math display">\[
H(a,x) = \begin{cases}
\frac{1}{P(A = 1\mid X)}&amp;\text{if }a=1 \\
\frac{-1}{P(A = 0\mid X)}&amp;\text{if }a=0
\end{cases}
\]</span> To create this in code, we first note the propensity scores which are known in this example,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>propensity_score <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">distinct</span>(x,pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then we write an <code>h()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="cf">function</span>(a,x) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(a, x) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(propensity_score, <span class="at">by =</span> <span class="fu">join_by</span>(x)) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">h =</span> <span class="fu">case_when</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> pi,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        a <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pi)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(h)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The graph below visualizes our <span class="math inline">\(h\)</span> values on the <span class="math inline">\(x\)</span>-axis and the errors of our initial model on the <span class="math inline">\(y\)</span>-axis, with a line that corresponds to the targeting step to be completed below.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="doubly_robust_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The targeting fit visualized in the model above is the linear regression of <span class="math inline">\(Y\)</span> on <span class="math inline">\(H(A,X)\)</span> (the clever covariate, which involves inverse probability weights), estimated with offset equal to the intial predictions <span class="math inline">\(Q^0(A,X)\)</span>.</p>
<p><span class="math display">\[
\hat{Q}^1(A,\vec{X}) = \text{E}^1\left(Y \mid A, \vec{X}\right) = \hat{Q}^0(A,\vec{X}) + \hat\gamma H(A,\vec{X})
\]</span></p>
<p>The slope of the line in the figure above equals the coefficient estimate <span class="math inline">\(\hat\gamma\)</span> in the equation above. In code, below we estimate the targeting regression model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>q1_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">q0</span>(a,x)) <span class="sc">+</span> <span class="fu">h</span>(a,x), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then write a <code>q1()</code> function that will return targeted predictions at treatment value <code>a</code> and confounder value <code>x</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>q1 <span class="ot">&lt;-</span> <span class="cf">function</span>(a,x) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(q1_fit, <span class="at">newdata =</span> <span class="fu">tibble</span>(a,x))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the <span class="math inline">\(\hat{Q}^1\)</span> function, we can produce a targeted estimate of the ATE.</p>
<p><span class="math display">\[
\hat\tau_\text{ATE}^1 = \underbrace{\frac{1}{n}\sum_i}_\text{Sample average} \bigg(\underbrace{\hat{Q}^1(1,x_i)}_{\substack{\text{Targeted prediction}\\\text{under treatment}}} - \underbrace{\hat{Q}^1(0,x_i)}_{\substack{\text{Targeted prediction}\\\text{under control}}}\bigg)
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">targeted_ate_estimate =</span> <span class="fu">mean</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">q1</span>(<span class="dv">1</span>,x) <span class="sc">-</span> <span class="fu">q1</span>(<span class="dv">0</span>,x)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  targeted_ate_estimate
                  &lt;dbl&gt;
1                   1.6</code></pre>
</div>
</div>
<p>Because this example is constructed with no random noise and known treatment probabilities, the targeted ATE estimate exactly matches the true ATE of 1.6.</p>
</section>
<section id="why-tmle-vs-aipw" class="level3">
<h3 class="anchored" data-anchor-id="why-tmle-vs-aipw">Why TMLE vs AIPW?</h3>
<p>Why would one choose TMLE over AIPW?</p>
<p>Both approaches solve the same problem: when building an outcome model for <span class="math inline">\(Y^1\)</span>, the model is learned over the confounder distribution <span class="math inline">\(\vec{X}\mid A = 1\)</span> among treated units, but the goal is to predict over the distribution <span class="math inline">\(\vec{X}\mid A = 0\)</span> among untreated units. When the outcome model is going to fit poorly in part of the space (e.g., due to model misspecification), then the first-stage model will optimize fit in the part of the space where it observes more data. But this may not be the same as the part of the space where predictions are to be made.</p>
<p>AIPW and TMLE solve this problem in related but distinct ways. In AIPW, the outcome model is corrected by the weighted average error where weights equal inverse probability of treatment weights. In TMLE, the outcome model is corrected by a second-stage regression that uses inverse probability of treatment weights as a “clever covariate” in a regression model.</p>
<p>Ultimately, both approaches are doubly robust. One advantage of TMLE arises when the outcome is binary, because then the second-stage regression can be a generalized linear model where the TMLE correction occurs on the space of the linear predictor. Thus, TMLE can be constructed to enforce boundaries such as never predicting probabilities below 0 or greater than 1.</p>
<p>In practice, I have not seen a clear resolution in favor of one or the other approach, and both approaches are likely to be good estimators. Any doubly-robust method may be preferable to the more typical approach of relying entirely on an outcome or treatment model!</p>
<!-- ### TMLE with a binary outcome -->
<!-- A benefit of TMLE is that it can be carried out with a binary outcome. -->
<!-- Note: I tried to construct a setting where -->
<!-- * treatment model is correctly specified -->
<!-- * outcome model is incorrectly specified -->
<!-- * AIPW makes an estimate outside (0,1) -->
<!-- Other than a few numerical edge cases that may have come from logit not converging, I am not able to create such a simulation. I think this is analogous to how a linear probability model only leads to the problem of predicting outside the (0,1) interval when that model is incorrectly specified. -->
<!-- ```{r} -->
<!-- base_data <- tibble(x = c(rep(1:2, each = 99), 3), a = TRUE) |> -->
<!--   bind_rows( -->
<!--     tibble(x = c(1:2,rep(3, 99)), a = FALSE) -->
<!--   ) -->
<!-- base_data |> -->
<!--   table() -->
<!-- data <- base_data |> -->
<!--   mutate( -->
<!--     pi = case_when( -->
<!--       x == 1 ~ .99, -->
<!--       x == 2 ~ .99, -->
<!--       x == 3 ~ .01 -->
<!--     ), -->
<!--     y1 = case_when( -->
<!--       x == 1 ~ .5, -->
<!--       x == 2 ~ .5, -->
<!--       x == 3 ~ .9 -->
<!--     ), -->
<!--     y0 = 0, -->
<!--     y = ifelse(a, y1, y0) -->
<!--   ) -->
<!-- fit <- lm(y ~ x, data = data |> filter(a)) -->
<!-- correction <- data |> -->
<!--   filter(a) |> -->
<!--   mutate( -->
<!--     error = predict(fit) - y, -->
<!--     weight = (1 - pi) / pi -->
<!--   ) |> -->
<!--   summarize(correction = weighted.mean(error, w = weight)) |> -->
<!--   print() -->
<!-- data |>  -->
<!--   filter(a) |> -->
<!--   mutate(yhat = predict(fit, newdata = data |> filter(a))) |> -->
<!--   mutate(weight = (1 - pi) / pi) |> -->
<!--   ggplot(aes(x = x)) + -->
<!--   geom_hline(yintercept = 1, linetype = "dashed") + -->
<!--   geom_jitter(aes(y = y, size = weight), width = .1, height = .005, alpha = .2) + -->
<!--   geom_line(aes(y = yhat)) + -->
<!--   ylab("Observed Outcomes\nof Treated Units") + -->
<!--   xlab("Confounder X") + -->
<!--   scale_size_continuous( -->
<!--     name = "Treatment\nWeight for\nATC", -->
<!--     breaks = c(.01,99), -->
<!--     limits = c(.01,99) -->
<!--   ) + -->
<!--   labs( -->
<!--     subtitle = paste( -->
<!--       "Weighted mean error:\nLine is", -->
<!--       correction |> pull(correction) |> round(2), -->
<!--       "too low" -->
<!--     ) -->
<!--   ) -->
<!-- data |> -->
<!--   filter(!a) |> -->
<!--   mutate(initial = predict(fit, newdata = data |> filter(!a))) |> -->
<!--   select(x, initial) |> -->
<!--   mutate(corrected = initial - correction$correction) |> -->
<!--   pivot_longer(cols = -x) |> -->
<!--   ggplot(aes(x = x, y = value, linetype = name)) + -->
<!--   geom_hline(yintercept = 1, linetype = "dashed") + -->
<!--   geom_jitter(width = .1, height = .01, alpha = .2) + -->
<!--   geom_line() -->
<!-- # Run many times with sampling variability -->
<!-- simulate <- function() { -->
<!--   data_simulated <- data |> -->
<!--     # Randomize Y from Bernoulli with existing probability -->
<!--     mutate( -->
<!--       y = rbinom(n(), 1, y) -->
<!--     ) -->
<!--   fit <- lm(y ~ x, data = data_simulated |> filter(a)) -->
<!--   correction <- data_simulated |> -->
<!--     filter(a) |> -->
<!--     mutate( -->
<!--       error = predict(fit) - y, -->
<!--       weight = (1 - pi) / pi -->
<!--     ) |> -->
<!--     summarize(correction = weighted.mean(error, w = weight)) -->
<!--   estimate <- data_simulated |> -->
<!--     filter(!a) |> -->
<!--     mutate(yhat1 = predict(fit, newdata = data_simulated |> filter(!a))) |> -->
<!--     summarize(initial = mean(yhat1)) |> -->
<!--     mutate(corrected = initial - correction$correction) -->
<!--   return(estimate) -->
<!-- } -->
<!-- simulations <- foreach(r = 1:500, .combine = "rbind") %do% simulate() -->
<!-- simulations |> -->
<!--   pivot_longer(cols = everything()) |> -->
<!--   ggplot(aes(x = value)) + -->
<!--   geom_histogram() + -->
<!--   facet_wrap(~name) -->
<!-- simulations |> -->
<!--   arrange(-corrected) -->
<!-- ``` -->
</section>
</section>
<section id="sample-splitting-for-machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="sample-splitting-for-machine-learning">Sample splitting for machine learning</h2>
<p>Under classical statistical approaches to inference, one often worries about model misspecification. The problem of model misspecification is that if one approximates <span class="math inline">\(\text{E}(Y\mid A, \vec{X})\)</span> by an additive regression and the true response function is nonlinear, then the model will be an inconsistent estimator of <span class="math inline">\(\text{E}(Y\mid\vec{X} = \vec{x})\)</span> for at least some <span class="math inline">\(\vec{x}\)</span>. Double robustness solves this problem: as long as <span class="math inline">\(\text{E}(Y\mid\vec{X})\)</span> or <span class="math inline">\(\text{P}(A = 1\mid\vec{X})\)</span> is estimated by a consistent estimator, then the causal effect estimate is consistent.</p>
<p>Machine learning approaches seem to upend this logic: flexible models can be consistent estimators by construction. Without any assumption of a statistical model, a random forest can yield a consistent estimator of <span class="math inline">\(\text{E}(Y\mid A,\vec{X})\)</span> and <span class="math inline">\(\text{P}(A = 1\mid\vec{X})\)</span>. By consistent, we mean that the forest would come to equal these estimands in an infinite sample. Does double robustness then have any use?</p>
<p>The problem with flexible machine learning estimators is that they converge to the true response surface at slower rates than parametric regression models. In finite samples, the estimators will be biased at some <span class="math inline">\(\vec{X} = \vec{x}\)</span> values due to regularization. Thus, the key to machine learning estimators is to do use the same doubly robust formulation, with a small twist.</p>
<ol type="1">
<li><p>Using sample <span class="math inline">\(\mathcal{S}_1\)</span>, estimate two prediction functions <span class="math display">\[
\begin{aligned}
\hat{g}(\mathcal{S}_1,a,\vec{x}) &amp;= \hat{\text{E}}(Y\mid A = a, \vec{X} = \vec{x}) \\
\hat{m}(\mathcal{S}_1,a,\vec{x}) &amp;= \hat{\text{P}}(A = a \mid \vec{X} = \vec{x}) \\
\end{aligned}
\]</span></p></li>
<li><p>In sample <span class="math inline">\(\mathcal{S}_2\)</span>, apply the AIPW estimator. <span class="math display">\[
\begin{aligned}
\hat{\text{E}}(Y^a) &amp;= \underbrace{\frac{1}{\lvert\mathcal{S}_2\rvert}\sum_{i\in\mathcal{S}_2}\hat{g}(\mathcal{S}_1,a,\vec{X}_i)}_{\text{outcome modeling estimator}} -
\underbrace{\frac{1}{\sum_{i\in\mathcal{S}_2}\frac{\mathbb{I}(A_i=a)}{\hat{m}(\mathcal{S}_1, A_i,\vec{X}_i)}}\sum_{i\in\mathcal{S}_2}\frac{\mathbb{I}(A_i=a)\bigg(\hat{g}(\mathcal{S}_1, A_i,\vec{X}_i) - y_i\bigg)}{\hat{m}(\mathcal{S}_1, A_i,\vec{X}_i)}}_\text{debiasing correction}
\end{aligned}
\]</span></p></li>
</ol>
<p>If we drop the normalizing constant on the weights in the debiasing correction (which on asymptotically equals the number of treated observations), we get an estimator that can be written as an empirical mean <span class="math inline">\(\hat{\text{E}}_{\mathcal{S}_2}\)</span> over the cases in sample <span class="math inline">\(\mathcal{S}_2\)</span>.</p>
<p><span class="math display">\[
\hat\tau(a) = \hat{\text{E}}_{\mathcal{S}_2}\left(
  \hat{g}(\mathcal{S}_1,a,\vec{X})
  -
  \frac{\mathbb{I}(A=a)\bigg(\hat{g}(\mathcal{S}_1, A,\vec{X}) - Y\bigg)}{\hat{m}(\mathcal{S}_1, A,\vec{X})}
\right)
\]</span></p>
<p>When <span class="math inline">\(\hat{g}\rightarrow g\)</span> and <span class="math inline">\(\hat{m}\rightarrow m\)</span> at slower asymptotic rates than we ordinarily observe for linear regression, it is still possible for <span class="math inline">\(\hat\tau\rightarrow \tau\)</span> at the ordinary <span class="math inline">\(\sqrt{n}\)</span> asymptotic rate. In other words, even if you estimate a <span class="math inline">\(\hat{g}\)</span> and <span class="math inline">\(\hat{m}\)</span> with random forests, it is possible for <span class="math inline">\(\hat\tau\)</span> to converge to the true expected potential outcome at a rate with good properties! A key for this to happen is that <span class="math inline">\(\hat{g}\)</span> and <span class="math inline">\(\hat{m}\)</span> are learned in a separate sample from the one in which they are applied.</p>
<section id="cross-fitting" class="level3">
<h3 class="anchored" data-anchor-id="cross-fitting">Cross fitting</h3>
<p>Similar to the move from a train-test split to cross-validation, one can make a similar move from sample splitting to a technique called cross fitting.</p>
<ol type="1">
<li>In sample <span class="math inline">\(\mathcal{S}_1\)</span>, estimate the outcome model <span class="math inline">\(g(\mathcal{S}_1,a,\vec{x})\)</span> and treatment model <span class="math inline">\(\hat{m}(\mathcal{S}_1,a)\)</span>.</li>
<li>In sample <span class="math inline">\(\mathcal{S}_2\)</span>, produce an AIPW estimate.</li>
<li>Repeat steps (1) and (2), swapping the roles of <span class="math inline">\(\mathcal{S}_1\)</span> and <span class="math inline">\(\mathcal{S}_2\)</span>.</li>
<li>Average the results.</li>
</ol>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<p>Carry out the child’s analysis by</p>
<ul>
<li>an outcome model.</li>
<li>inverse probability weighting, with weights estimated by logistic regression</li>
<li>augmented inverse probability weighting</li>
</ul>
<!-- Child's analysis by machine learning. -->
<!-- ```{r} -->
<!-- generate_data <- function(n = 90, noise = .1, replace = T) { -->
<!--   tibble(x = rep(1:9,1:9), a = F) |> -->
<!--     bind_rows(tibble(x = rep(1:9,9:1), a = T)) |> -->
<!--     sample_n(n, replace = replace) |> -->
<!--     mutate( -->
<!--       y1 = 9 - 9 * ((x - 5) / 5) ^ 2, -->
<!--       y0 = 5, -->
<!--       # Shift x to fit story of this DGP -->
<!--       x = (x - 1) / 2 + 1, -->
<!--       y = case_when( -->
<!--         !a ~ y0, -->
<!--         a ~ y1 -->
<!--       ) + runif(n(), -noise, noise) -->
<!--     ) -->
<!-- } -->
<!-- ``` -->
<!-- ### Statistical estimator -->
<!-- ```{r} -->
<!-- estimator <- function(n = 100) { -->
<!--   full_data <- generate_data(n) -->
<!--   g_fit <- glm(y ~ x + a, data = full_data) -->
<!--   m_fit <- glm(a ~ x, data = full_data, family = binomial) -->
<!--   set_to_treated <- full_data |> mutate(a = T) -->
<!--   # Truth -->
<!--   truth <- generate_data(noise = 0, replace = F) |> -->
<!--     summarize(truth = mean(y1)) |> -->
<!--     pull(truth) -->
<!--   # Outcome modeling -->
<!--   outcome_estimate <- set_to_treated |> -->
<!--     mutate(ghat = predict(g_fit, newdata = set_to_treated)) |> -->
<!--     summarize(estimate = mean(ghat)) |> -->
<!--     pull(estimate) -->
<!--   # IPW -->
<!--   ipw_estimate <- full_data |> -->
<!--     mutate(mhat = predict(m_fit, data = full_data, type = "response")) |> -->
<!--     filter(a) |> -->
<!--     summarize(estimate = weighted.mean(y, w = 1 / mhat)) |> -->
<!--     pull(estimate) -->
<!--   # Doubly robust estimator -->
<!--   treated_cases <- full_data |> filter(a) -->
<!--   correction <- treated_cases |> -->
<!--     mutate( -->
<!--       mhat = predict(m_fit, newdata = treated_cases, type = "response"), -->
<!--       ghat = predict(g_fit, newdata = treated_cases) -->
<!--     ) |> -->
<!--     summarize( -->
<!--       correction = weighted.mean( -->
<!--         ghat - y, w = 1 / mhat -->
<!--       ) -->
<!--     ) |> -->
<!--     pull(correction) -->
<!--   tibble( -->
<!--     outcome = outcome_estimate, -->
<!--     ipw = ipw_estimate, -->
<!--     dr = outcome_estimate - correction, -->
<!--     truth = truth -->
<!--   ) -->
<!-- } -->
<!-- ``` -->
<!-- Repeat on many samples -->
<!-- ```{r} -->
<!-- results <- foreach(sample_size = c(seq(100,500,100)), .combine = "rbind") %do% { -->
<!--   foreach(rep = 1:100, .combine = "rbind") %do% { -->
<!--     estimator(n = sample_size) |> -->
<!--       mutate(sample_size = sample_size) -->
<!--   } -->
<!-- } -->
<!-- results |> -->
<!--   select(-truth) |> -->
<!--   pivot_longer(cols = -sample_size) |> -->
<!--   ggplot(aes(x = sample_size, y = value, color = name)) + -->
<!--   #geom_line() + -->
<!--   geom_point() + -->
<!--   facet_wrap(~name) -->
<!-- results |> -->
<!--   group_by(sample_size) |> -->
<!--   summarize_all(mean) |> -->
<!--   pivot_longer(cols = -sample_size) |> -->
<!--   ggplot(aes(x = sample_size, y = value, color = name)) + -->
<!--   geom_line() + -->
<!--   geom_point() -->
<!-- truth_value <- results$truth[1] -->
<!-- results |> -->
<!--   select(-truth) |> -->
<!--   group_by(sample_size) |> -->
<!--   summarize_all(\(x) mean((x - truth_value) ^ 2)) |> -->
<!--   pivot_longer(cols = -sample_size) |> -->
<!--   ggplot(aes(x = sample_size, y = value, color = name)) + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   labs( -->
<!--     y = "Mean Squared Error", -->
<!--     x = "Sample Size", -->
<!--     name = "Estimator" -->
<!--   ) -->
<!-- ``` -->
<!-- ### Machine learning estimator -->
<!-- ```{r} -->
<!-- estimator <- function(n = 100) { -->
<!--   full_data <- generate_data(n) -->
<!--   g_fit <- ranger(y ~ x + a, data = full_data) -->
<!--   m_fit <- ranger(as.numeric(a) ~ x, data = full_data) -->
<!--   set_to_treated <- full_data |> mutate(a = T) -->
<!--   # Truth -->
<!--   truth <- generate_data(noise = 0, replace = F) |> -->
<!--     summarize(truth = mean(y1)) -->
<!--   # Outcome modeling -->
<!--   outcome_estimate <- set_to_treated |> -->
<!--     mutate(ghat = predict(g_fit, data = set_to_treated)$predictions) |> -->
<!--     summarize(outcome_model_estimate = mean(ghat)) -->
<!--   # IPW -->
<!--   ipw_estimate <- full_data |> -->
<!--     mutate(mhat = predict(m_fit, data = full_data)$predictions) |> -->
<!--     filter(a) |> -->
<!--     summarize(estimate = weighted.mean(y, w = 1 / mhat)) -->
<!--   # Doubly robust estimator -->
<!--   treated_cases <- full_data |> filter(a) -->
<!--   correction <- treated_cases |> -->
<!--     mutate( -->
<!--       mhat = predict(m_fit, data = treated_cases)$predictions, -->
<!--       ghat = predict(g_fit, data = treated_cases)$predictions -->
<!--     ) |> -->
<!--     summarize( -->
<!--       correction = weighted.mean( -->
<!--         ghat - y, w = 1 / mhat -->
<!--       ) -->
<!--     ) -->
<!--   tibble( -->
<!--     outcome = outcome_estimate$outcome_model_estimate, -->
<!--     ipw = ipw_estimate$estimate, -->
<!--     dr = outcome_estimate$outcome_model_estimate -  -->
<!--       correction$correction, -->
<!--     truth = truth$truth -->
<!--   ) -->
<!-- } -->
<!-- ``` -->
<!-- What happens as sample size grows? -->
<!-- ```{r} -->
<!-- results <- foreach(sample_size = c(250,500,1000,2000,4000), .combine = "rbind") %do% { -->
<!--   foreach(rep = 1:10, .combine = "rbind") %do% { -->
<!--     estimator(n = sample_size) |> -->
<!--       mutate(sample_size = sample_size) -->
<!--   } -->
<!-- } -->
<!-- results |> -->
<!--   group_by(sample_size) |> -->
<!--   summarize_all(mean) |> -->
<!--   pivot_longer(cols = -sample_size) |> -->
<!--   ggplot(aes(x = sample_size, y = value, color = name)) + -->
<!--   geom_line() + -->
<!--   geom_point() -->
<!-- ``` -->
<!-- # ```{r, echo = F} -->
<!-- # data <- tibble( -->
<!-- #   x = c(1,1,1,2,2,3,1,2,2,3,3,3), -->
<!-- #   a = c(F,F,F,F,F,F,T,T,T,T,T,T), -->
<!-- #   y = c(1,1,1,2,2,2,2,3,3,3,3,3) -->
<!-- # ) |> -->
<!-- #   group_by(x) |> -->
<!-- #   mutate(pi = mean(a)) |> -->
<!-- #   ungroup() -->
<!-- #  -->
<!-- # data |> -->
<!-- #   ggplot(aes(x = x, y = y, color = a)) + -->
<!-- #   geom_point() -->
<!-- # ``` -->


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The targeted learning literature typically uses <span class="math inline">\(Q^0\)</span> instead of <span class="math inline">\(\hat{Q}^0\)</span>, but we use the hat for consistency within this webpage that estimated quantities always have hats.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>